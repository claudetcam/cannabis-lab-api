import time
import gspread
from oauth2client.service_account import ServiceAccountCredentials
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.common.by import By
from webdriver_manager.chrome import ChromeDriverManager

# --- Étape 1 : Authentification Google Sheets ---
json_keyfile = "credentials.json"  # nom du fichier de clé téléchargé
spreadsheet_url = "https://docs.google.com/spreadsheets/d/1ZGZdBOn3nbOd7LVOG6-LSQ9jfxGlXEtxhLD7YYvWzd8/edit"

scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
credentials = ServiceAccountCredentials.from_json_keyfile_name(json_keyfile, scope)
client = gspread.authorize(credentials)

sheet = client.open_by_url(spreadsheet_url).worksheet("Labs-Massachusetts")

# --- Étape 2 : Scraping avec Selenium ---
options = webdriver.ChromeOptions()
options.add_argument("--headless")
options.add_argument("--no-sandbox")
options.add_argument("--disable-dev-shm-usage")

driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()), options=options)
driver.get("https://masscannabiscontrol.com/licensing-tracker/")
time.sleep(5)  # attendre le chargement complet JS

elements = driver.find_elements(By.CLASS_NAME, "licensee")
labs = []

for el in elements:
    try:
        parent = el.find_element(By.XPATH, "..")
        name = el.text.strip()
        license_type = parent.find_element(By.CLASS_NAME, "license-type").text.strip()
        location = parent.find_element(By.CLASS_NAME, "license-location").text.strip()
        priority = parent.find_element(By.CLASS_NAME, "license-priority").text.strip()
        summary = parent.find_element(By.CLASS_NAME, "executive-summary").text.strip()

        if "Independent Testing Laboratory" in license_type:
            labs.append([name, license_type, location, priority, summary, "", "", "Active"])
    except Exception as e:
        print("Erreur sur un élément:", e)
        continue

driver.quit()

# --- Étape 3 : Mise à jour du Google Sheet ---
sheet.resize(rows=3)  # conserve en-têtes
sheet.update("A4", labs)

print(f"{len(labs)} laboratoires actifs ont été mis à jour avec succès ✅")
